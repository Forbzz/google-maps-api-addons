/**
 * @license Copyright 2014 Martin Matysiak.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(e,t){if(typeof module==="object"&&typeof module.exports==="object"){module.exports=t()}else if(typeof define==="function"&&typeof define.amd==="object"){define(["goog!maps,3,other_params:[sensor=false&libraries=visualization]"],t)}else{if(typeof google!=="object"||typeof google.maps!=="object"){throw new Error("PanoMarker requires google maps library")}e.PanoMarker=t()}})(typeof window!=="undefined"?window:this,function(){var e=function(t){t=t||{};this.anchor_=t.anchor||new google.maps.Point(16,16);this.className_=t.className||null;this.clickable_=t.clickable||true;this.icon_=t.icon||null;this.id_=t.id||null;this.marker_=null;this.pano_=null;this.pollId_=-1;this.position_=t.position||{heading:0,pitch:0};this.povListener_=null;this.zoomListener_=null;this.size_=t.size||new google.maps.Size(32,32);this.title_=t.title||"";this.visible_=t.visible||true;this.zIndex_=t.zIndex||1;this.setPano(t.pano||null);this.povToPixel_=!!window.chrome?e.povToPixel3d:e.povToPixel2d};e.prototype=new google.maps.OverlayView;e.get3dFov=function(e){return e<=2?126.5-e*36.75:195.93/Math.pow(1.92,e)};e.povToPixel3d=function(t,n,r,i){var s=i.offsetWidth;var o=i.offsetHeight;var u={left:s/2,top:o/2};var a=Math.PI/180;var f=e.get3dFov(r)*a;var l=n.heading*a;var c=n.pitch*a;var h=t.heading*a;var p=t.pitch*a;var d=s/2/Math.tan(f/2);var v=Math.cos(p);var m=Math.sin(p);var g=Math.cos(h);var y=Math.sin(h);var b=d*v*y;var w=d*v*g;var E=d*m;var S=Math.cos(c);var x=Math.sin(c);var T=Math.cos(l);var N=Math.sin(l);var C=d*S*N;var k=d*S*T;var L=d*x;var A=C*b+k*w+L*E;var O=C*C+k*k+L*L;if(Math.abs(A)<1e-6){return null}var M=O/A;if(M<0){return null}var _=M*b;var D=M*w;var P=M*E;var H=-x*N;var B=-x*T;var j=S;var F=T;var I=-N;var q=0;var R=Math.sqrt(F*F+I*I+q*q);F/=R;I/=R;q/=R;var U=_*F+D*I+P*q;var z=_*H+D*B+P*j;u.left+=U;u.top-=z;return u};e.povToPixel2d=function(e,t,n,r){var i=r.offsetWidth;var s=r.offsetHeight;var o={left:i/2,top:s/2};var u=180/Math.pow(2,n);var a=u*(s/i);var f=e.heading-t.heading;var l=e.pitch-t.pitch;o.left+=f/u*i;o.top-=l/a*s;return o};e.prototype.onAdd=function(){if(!!this.marker_){return}var e=document.createElement("div");e.style.position="absolute";e.style.cursor="pointer";e.style.width=this.size_.width+"px";e.style.height=this.size_.height+"px";e.style.display=this.visible_?"block":"none";e.style.zIndex=this.zIndex_;if(this.id_){e.id=this.id_}if(this.className_){e.className=this.className_}if(this.title_){e.title=this.title_}if(this.icon_){e.style.backgroundImage="url("+this.icon_+")"}if(!(this.id_||this.className_||this.icon_)){e.style.backgroundImage="url(https://www.google.com/intl/en_us/"+"mapfiles/ms/micons/red-dot.png)"}this.marker_=e;this.getPanes().overlayMouseTarget.appendChild(e);window.addEventListener("resize",this.draw.bind(this));this.povListener_=google.maps.event.addListener(this.getMap(),"pov_changed",this.draw.bind(this));this.zoomListener_=google.maps.event.addListener(this.getMap(),"zoom_changed",this.draw.bind(this));if(e.attachEvent){e.attachEvent("onclick",this.onClick.bind(this))}else{e.addEventListener("click",this.onClick.bind(this),false)}this.draw()};e.prototype.draw=function(){if(!this.pano_){return}var e=this.povToPixel_(this.position_,this.pano_.getPov(),this.pano_.getZoom()!=null?this.pano_.getZoom():1,this.pano_.getContainer());if(e!==null){this.marker_.style.left=e.left-this.anchor_.x+"px";this.marker_.style.top=e.top-this.anchor_.y+"px"}else{this.marker_.style.left=-(9999+this.size_.width)+"px";this.marker_.style.top="0"}};e.prototype.onClick=function(e){if(this.clickable_){google.maps.event.trigger(this,"click")}e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}};e.prototype.onRemove=function(){if(!this.marker_){return}google.maps.event.removeListener(this.povListener_);google.maps.event.removeListener(this.zoomListener_);this.marker_.parentNode.removeChild(this.marker_);this.marker_=null};e.prototype.getAnchor=function(){return this.anchor_};e.prototype.getClassName=function(){return this.className_};e.prototype.getClickable=function(){return this.clickable_};e.prototype.getIcon=function(){return this.icon_};e.prototype.getId=function(){return this.id_};e.prototype.getPano=function(){return this.pano_};e.prototype.getPosition=function(){return this.position_};e.prototype.getSize=function(){return this.size_};e.prototype.getTitle=function(){return this.title_};e.prototype.getVisible=function(){return this.visible_};e.prototype.getZIndex=function(){return this.zIndex_};e.prototype.setAnchor=function(e){this.anchor_=e;this.draw()};e.prototype.setClassName=function(e){this.className_=e;if(!!this.marker_){this.marker_.className=e}};e.prototype.setClickable=function(e){this.clickable_=e};e.prototype.setIcon=function(e){this.icon_=e;if(!!this.marker_){this.marker_.style.backgroundImage=!!e?"url("+e+")":""}};e.prototype.setId=function(e){this.id_=e;if(!!this.marker_){this.marker_.id=e}};e.prototype.setPano=function(e){if(!!e&&!(e instanceof google.maps.StreetViewPanorama)){throw"PanoMarker only works inside a StreetViewPanorama."}if(!!this.pano_){this.onRemove()}this.setMap(e);this.pano_=e;if(!!e){if(!!this.getPanes()){this.onAdd()}else{var t=function(){if(!!this.getPanes()){window.clearInterval(this.pollId_);this.onAdd()}};this.pollId_=window.setInterval(t.bind(this),10)}}};e.prototype.setPosition=function(e){this.position_=e;this.draw()};e.prototype.setSize=function(e){this.size_=e;if(!!this.marker_){this.marker_.style.width=e.width+"px";this.marker_.style.height=e.height+"px";this.draw()}};e.prototype.setTitle=function(e){this.title_=e;if(!!this.marker_){this.marker_.title=e}};e.prototype.setVisible=function(e){this.visible_=e;if(!!this.marker_){this.marker_.style.display=e?"block":"none"}};e.prototype.setZIndex=function(e){this.zIndex_=e;if(!!this.marker_){this.marker_.style.zIndex=e}};return e})
